---
title: "Boxplots for Expression based Genetic Dependency Detection"
author: "Martin Brand"
date: "`r format(Sys.time(), '%B %e, %Y')`"
output:
  bookdown::html_document2:
    code_folding: hide
    fig_caption: yes
    number_sections: no
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
    toc_collapsed: yes
    fig_width: 8 
    fig_height: 4 
  bookdown::pdf_document2:
    keep_tex: yes
    fig_caption: yes
    number_sections: no
    toc: yes
    toc_depth: 3
graphics: yes
header-includes:
- \makeatletter\renewcommand*{\fps@figure}{h}\makeatother
- \usepackage{placeins}
geometry: margin=1in
fontsize: 18pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(ggplot2)
library(gridExtra)
library(ggpubr)
library(readxl)
library(kableExtra)
library(dplyr)
```

```{r}
classification.gene.HUGO <- "FUBP1"
classification.gene.entrez <- "8880"
target.gene <- "FUBP1"
```

# Data Preprocessing
```{r, warning=FALSE}
path <-
  "C:/Users/Martin/Documents/Master/Thesis/genetic_dependency_detection/data/"
dep.scores.DRIVE <- readRDS(paste0(path,"dep.scores.DRIVE.rds"))
dep.scores.Achilles <- readRDS(paste0(path,"dep.scores.Achilles.rds"))

path <- "C:/Users/Martin/Documents/Master/Thesis/CCLE_data/"

# load CCLE dataset
expression.data <- readRDS(paste0(path,"Expression_Files/expression.data.rds"))

# change rownames format
rownames(expression.data) <- 
  substr(rownames(expression.data),1,nchar(rownames(expression.data))-3)

# make rownames to first column
expression.data$entrez.gene.id <- rownames(expression.data)
expression.data <- expression.data %>% select(entrez.gene.id, everything())
rownames(expression.data) <- NULL

source("helper_functions/create.classification.table.expr.R")
source("helper_functions/create.dep.score.boxplots.R")

rm(path)
```

```{r}
expression.class.gene <- 
  t(expression.data[expression.data$entrez.gene.id==classification.gene.entrez,-1])
expression.class.gene <- as.data.frame(expression.class.gene)
expression.class.gene$CCLE_ID <- rownames(expression.class.gene)
rownames(expression.class.gene) <- NULL
colnames(expression.class.gene) <- c("expr.level","CCLE_ID")

ggplot(expression.class.gene,aes(expr.level)) +
  geom_histogram(bins = 40)
```

# Classification Table
The isMutated==TRUE property stands here for highly-expressing cell lines and isMutated==FALSE for low-expressing cell lines.
```{r}
sample.share <- 0.2

class.tables <- create.classification.table.expr(
  sample.share,expression.class.gene,dep.scores.DRIVE,dep.scores.Achilles)

class.table.DRIVE <- class.tables$DRIVE
colnames(class.table.DRIVE)[2] <- "isMutated"
class.table.Achilles <- class.tables$Achilles
colnames(class.table.Achilles)[2] <- "isMutated"

rm(sample.share, expression.class.gene,class.tables)

# show tables
class.table.DRIVE %>%
  head() %>%
  kbl(caption = "Classification Table in DRIVE") %>%
  kable_styling()
class.table.Achilles %>%
  head %>%
  kbl(caption = "Classification Table in Achilles") %>%
  kable_styling()
```


# Do the distributions of both sampes differ?
```{r}
boxplot.target.gene.Achilles <- 
  create.dep.score.boxplots(dep.scores.Achilles,target.gene,
                            class.table.Achilles,"Achilles",
                            pos.p.value = 1.6,
                            sample.name.1 = "-\nlow-expressing",
                            sample.name.2 = "-\nhighly-expressing")

boxplot.target.gene.DRIVE <- 
  create.dep.score.boxplots(dep.scores.DRIVE,target.gene,
                            class.table.DRIVE,"DRIVE",
                            pos.p.value = 0.7,
                            sample.name.1 = "-\nlow-expressing",
                            sample.name.2 = "-\nhighly-expressing")

grid.arrange(boxplot.target.gene.DRIVE,boxplot.target.gene.Achilles,ncol=2)
```