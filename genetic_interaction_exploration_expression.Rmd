---
title: "Genetic Dependency Detection based on Gene Expression"
author: "Martin Brand"
date: "`r format(Sys.time(), '%B %e, %Y')`"
output:
  bookdown::html_document2:
    code_folding: hide
    fig_caption: yes
    number_sections: no
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
    toc_collapsed: yes
    fig_width: 8 
    fig_height: 4 
  bookdown::pdf_document2:
    keep_tex: yes
    fig_caption: yes
    number_sections: no
    toc: yes
    toc_depth: 3
graphics: yes
header-includes:
- \makeatletter\renewcommand*{\fps@figure}{h}\makeatother
- \usepackage{placeins}
geometry: margin=1in
fontsize: 18pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, message=FALSE, warning=FALSE}
Sys.setenv(LANG = "en")
library(dplyr)
library(ggplot2)
library(kableExtra)
library(matrixTests)
library(limma)
library(ggrepel)
library(gridExtra)
library(ComplexHeatmap)
```

# Classification and target genes
First, we define the input data for the workflow: the gene we use for classification into high and low expressing cell lines, the sample share that determines how many cell lines are considered and the target genes to be displayed in the volcano plots.
```{r}
# target.genes <- c("FUBP1","SF1","U2AF1","U2AF2","SNRPB","SNRPD1","SNRPD2",
#                   "SNRPD3","SNRPE","SNRPF","SNRPG","PUF60","SMNDC1",
#                   "DNAJC8","RBM17","CHERP","U2SURP","DHX15","DDX46")

# target.genes <- c("EIF3A","SMNDC1")
# target.genes <- c("FUBP1","U2AF2")
# target.genes <- c("PUF60")
target.genes <- c("SNRPF")
# target.genes <- c("CCND1")

# Entrez ID 
classification.gene.HUGO <- "SNRPF"
classification.gene <- "6636"

sample.share <- 0.2
```

# Data Preprocessing
We load the gene expression dataset ([CCLE expression dataset](https://depmap.org/portal/download/all/?releasename=mRNA+expression&filename=CCLE_Expression_Entrez_2012-09-29.gct)) and the datasets that contains the dependency scores from the projects Achilles and DRIVE ([DepMap datasets](https://figshare.com/articles/dataset/DepMap_Datasets_for_WRN_manuscript/7712756/1)).
```{r, eval=FALSE}
library(CePa)
path <- "C:/Users/Martin/Documents/Master/Thesis/CCLE_data/"
expression.data <- 
  read.gct(
    paste0(path,"Expression_Files/CCLE_Expression_Entrez_2012-09-29.gct"))
expression.data <- as.data.frame(expression.data)
saveRDS(expression.data,
        file=paste0(path,"Expression_Files/expression.data.rds"))
```

```{r}
path <- "C:/Users/Martin/Documents/Master/Thesis/CCLE_data/"

# load CCLE dataset
expression.data <- readRDS(paste0(path,"Expression_Files/expression.data.rds"))

# change rownames format
expression.data.entrez <- expression.data
rownames(expression.data.entrez) <- 
  substr(rownames(expression.data),1,nchar(rownames(expression.data))-3)
# make rownames to first column
expression.data.entrez$entrezgene_id <- rownames(expression.data.entrez)
rownames(expression.data.entrez) <- NULL
expression.data.entrez <- expression.data.entrez %>%
  select(entrezgene_id, everything())

# load Achilles and DRIVE
path <- 
  "C:/Users/Martin/Documents/Master/Thesis/genetic_dependency_detection/data/"
dep.scores.DRIVE <- readRDS(paste0(path,"dep.scores.DRIVE.rds"))
dep.scores.Achilles <- readRDS(paste0(path,"dep.scores.Achilles.rds"))

rm(path,expression.data)
```

We load the helper functions.
```{r}
source("helper_functions/calc.mean.diffs.and.p.values.R")
source("helper_functions/create_volcano_plot.R")
source("helper_functions/create.classification.table.expr.R")
source("helper_functions/find.significant.genes.R")
source("helper_functions/create.upset.plot.R")
source("helper_functions/list.significant.genes.R")
```

# Data Exploration
## Gene expression distribution of `r classification.gene.HUGO` in each cell line
To investigate the expression level of the chosen classification gene, we plot the distribution of expression levels in the different cell lines.
```{r}
expression.class.gene <- as.data.frame(
  t(filter(expression.data.entrez,entrezgene_id==classification.gene))[-1,])
expression.class.gene$CCLE_ID <- rownames(expression.class.gene)
rownames(expression.class.gene) <- NULL
colnames(expression.class.gene) <- c("expr.level","CCLE_ID")
expression.class.gene$expr.level <- as.numeric(expression.class.gene$expr.level)

ggplot(expression.class.gene,aes(expr.level)) +
  geom_histogram(bins = 40)

rm(expression.data.entrez, classification.gene)
```

## Intersection of cell lines in Achilles or DRIVE and CCLE
In the workflow, we can only use cell lines that appear in both the CCLE and Achilles or DRIVE datasets. To check whether we have enough cell lines for the analysis, we determine the intersections.
```{r}
cell.lines.DRIVE.CCLE <- intersect(dep.scores.DRIVE$CCLE_ID,
                                   expression.class.gene$CCLE_ID)
cell.lines.Achilles.CCLE <- intersect(dep.scores.Achilles$CCLE_ID,
                                      expression.class.gene$CCLE_ID)
count.table <- as.data.frame(cbind(length(cell.lines.DRIVE.CCLE),
                                   length(cell.lines.Achilles.CCLE)))
colnames(count.table) <- c("DRIVE","Achilles")
rownames(count.table) <- "CCLE"

count.table %>%
  kbl() %>%
  kable_styling()

rm(cell.lines.DRIVE.CCLE,cell.lines.Achilles.CCLE,count.table)
```

# Data Analysis
## Classification table
We create two samples. One sample contains the overexpressed cell lines and the other contains the underexpressed cell lines. We summarise the samples in a classification table that shows whether a cell line is overexpressed or underexpressed.
```{r}
class.tables <- create.classification.table.expr(
  sample.share,expression.class.gene,dep.scores.DRIVE,dep.scores.Achilles)

class.table.DRIVE <- class.tables$DRIVE
class.table.Achilles <- class.tables$Achilles

rm(sample.share, expression.class.gene)

# show tables
class.table.DRIVE %>%
  head() %>%
  kbl(caption = "Classification Table in DRIVE") %>%
  kable_styling()
class.table.Achilles %>%
  head %>%
  kbl(caption = "Classification Table in Achilles") %>%
  kable_styling()
```

## Welch's t-test
We calculate the mean values of the dependency scores of both samples, take the difference and calculate the p-value using Welch's t-test.
```{r}
res <- calc.mean.diffs.and.p.values(dep.scores.DRIVE,dep.scores.Achilles,
                                    class.table.DRIVE,class.table.Achilles)

rm(class.table.DRIVE,class.table.Achilles,class.tables,dep.scores.DRIVE,
   dep.scores.Achilles)
```

```{r eval=TRUE, fig.height=4, fig.width=10}
plot.welch.DRIVE <- create_volcano_plot(res,"DRIVE","welch",target.genes)

plot.welch.Achilles <- create_volcano_plot(res,"Achilles","welch",target.genes)

grid.arrange(plot.welch.DRIVE,plot.welch.Achilles,ncol=2)

rm(plot.welch.DRIVE,plot.welch.Achilles)
```

## Wilcoxon test
We repeat the calculation of the p-values with the Wilcoxon test.
```{r eval=TRUE, fig.height=4, fig.width=10}
plot.wilc.DRIVE <- create_volcano_plot(test_results = res,
                                       dataset="DRIVE",
                                       test_method = "wilc",
                                       labeled_genes=target.genes,
                                       show_y_label = T)

plot.wilc.Achilles <- create_volcano_plot(test_results = res,
                                       dataset="Achilles",
                                       test_method = "wilc",
                                       labeled_genes=target.genes,
                                       show_y_label = F)

plot <- grid.arrange(plot.wilc.DRIVE,plot.wilc.Achilles,ncol=2)

# save plot
# plot_path <- 
# "C:/Users/Martin/Documents/Master/Thesis/report/plots/U2/expression_based/"
# ggsave(file=paste0(plot_path,"volcano_SNRPF_wilc_expr.svg"), plot=plot,
#        width=10)
# ggsave(file=paste0(plot_path,"volcano_SNRPF_wilc_expr.png"), plot=plot,
# width=10)

rm(plot.wilc.DRIVE,plot.wilc.Achilles)
```


## Bayes moderated t-test
And finally, we calculate the p-values with the Bayes moderated t-test.
```{r eval=TRUE, fig.height=4, fig.width=10}
plot.bayes.DRIVE <- create_volcano_plot(res,"DRIVE","bayes",target.genes)

plot.bayes.Achilles <- create_volcano_plot(res,"Achilles","bayes",target.genes)

grid.arrange(plot.bayes.DRIVE,plot.bayes.Achilles,ncol=2)

rm(plot.bayes.DRIVE,plot.bayes.Achilles,target.genes)
```



## Upset plots
To investigate whether genes have significant p-values in multiple tests and datasets, we create an upset plot. Each set contains all genes that are significant in the corresponding dataset and test method.
```{r fig.width=8}
significant.genes <- find.significant.genes(res=res)

create.upset.plot(significant.genes)

rm(res)
```

## Significant genes
We list the genes that appear in the maximum number of significant gene sets.
```{r}
final.significant.genes <- list.significant.genes(significant.genes)

# show result
final.significant.genes$final.significant.genes['geneID'] %>%
  kbl(caption = paste("Genes that are significant in",
                      final.significant.genes$max.set,"sets.")) %>%
  kable_styling()

rm(significant.genes,final.significant.genes)
```
