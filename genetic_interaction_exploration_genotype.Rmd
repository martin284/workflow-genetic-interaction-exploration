---
title: "Genetic Dependency Detection"
author: "Martin Brand"
date: "`r format(Sys.time(), '%B %e, %Y')`"
output:
  bookdown::html_document2:
    code_folding: hide
    fig_caption: yes
    number_sections: no
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
    toc_collapsed: yes
    fig_width: 8 
    fig_height: 4 
  bookdown::pdf_document2:
    keep_tex: yes
    fig_caption: yes
    number_sections: no
    toc: yes
    toc_depth: 3
graphics: yes
header-includes:
- \makeatletter\renewcommand*{\fps@figure}{h}\makeatother
- \usepackage{placeins}
geometry: margin=1in
fontsize: 18pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

We import the libraries.
```{r, message=FALSE}
#library(tidyverse)
library(ggplot2)
library(ggrepel)
library(matrixTests)
library(dplyr)
library(cowplot)
library(limma)
library(gridExtra)
```

# Analyzed Genes and Target
We define the genes for classification, the expected target gene and the classification criteria.
```{r}
gene1 <- "FUBP1"
gene2 <- "U2AF2"
# target.genes <- c("FUBP1","SF1","U2AF1","U2AF2","SNRPB","SNRPD1","SNRPD2",
#                   "SNRPD3","SNRPE","SNRPF","SNRPG","PUF60","SMNDC1",
#                   "DNAJC8","RBM17","CHERP","U2SURP","DHX15","DDX46")
target.genes <- c("U2AF2","FUBP1")
# possible methods: "del.vs.non.mut","mut.vs.non.mut"
classification.method <- "mut.vs.non.mut"
```
In this analysis, the genes used for classification are `r gene1` and `r gene2`. The expected target gene is `r target.genes`.

# Data Preprocessing
We define the directory for the data and helper functions.
```{r}
data.dir <-
  "C:/Users/Martin/Documents/Master/Thesis/genetic_dependency_detection/data/"
```

We load the dataset that contains CCLE IDs and corresponding DepMap IDs for the cell lines ([DepMapIDs](https://depmap.org/portal/download/all/?releasename=DepMap+Public+18Q3&filename=DepMap-2018q3-celllines.csv)), the dataset that contains the mutation information of the cell lines ([CCLE dataset](https://depmap.org/portal/download/all/?releasename=DepMap+Public+19Q2&filename=CCLE_mutations.csv)) and the datasets that contains the dependency scores from the projects Achilles and DRIVE ([DepMap datasets](https://figshare.com/articles/dataset/DepMap_Datasets_for_WRN_manuscript/7712756/1)).
```{r, message = FALSE, results="hide", eval=FALSE}
cancer.names <- read.csv(paste0(data.dir, "DepMap-2018q3-celllines.csv"))
cancer.names <- cancer.names[,c(1,2)]
colnames(cancer.names) <- c("DepMap_ID","CCLE_ID")

CCLE.mut <- read.csv(paste0(data.dir, "CCLE_mutations.csv"))
CCLE.mut <- CCLE.mut[,c(1,8,16,20)]

dep.scores <- read_rds(file.path(data.dir, 'DepMap_18Q4_data.rds'))

dep.scores.DRIVE <- as.data.frame(dep.scores[["DRIVE"]])
dep.scores.DRIVE$CCLE_ID <- rownames(dep.scores.DRIVE)
rownames(dep.scores.DRIVE) <- NULL
dep.scores.DRIVE <- dep.scores.DRIVE %>% select(CCLE_ID, everything())

dep.scores.Achilles <- as.data.frame(dep.scores[["CRISPR"]])
dep.scores.Achilles$CCLE_ID <- rownames(dep.scores.Achilles)
rownames(dep.scores.Achilles) <- NULL
dep.scores.Achilles <- dep.scores.Achilles %>% select(CCLE_ID,everything())

# remove unnecessary objects
rm(dep.scores)

# save important objects
saveRDS(cancer.names,paste0(data.dir,"cancer.names.rds"))
saveRDS(CCLE.mut,paste0(data.dir,"CCLE.mut.rds"))
saveRDS(dep.scores.DRIVE,paste0(data.dir,"dep.scores.DRIVE.rds"))
saveRDS(dep.scores.Achilles,paste0(data.dir,"dep.scores.Achilles.rds"))
```

```{r, eval=TRUE}
# load important objects
cancer.names <- readRDS(paste0(data.dir,"cancer.names.rds"))
CCLE.mut <- readRDS(paste0(data.dir,"CCLE.mut.rds"))
dep.scores.DRIVE <- readRDS(paste0(data.dir,"dep.scores.DRIVE.rds"))
dep.scores.Achilles <- readRDS(paste0(data.dir,"dep.scores.Achilles.rds"))
```

We load the helper functions.
```{r}
# load helper functions
source("helper_functions/create.mutation.counts.plot.R")
source("helper_functions/create.mutation.counts.plot.mark.R")
source("helper_functions/create.classification.table.mut.vs.non.mut.R")
source("helper_functions/create.classification.table.del.vs.non.mut.R")
source("helper_functions/merge.class.tables.R")
source("helper_functions/merge.class.tables.AND.R")
source("helper_functions/create_barcharts_classifications.R")
source("helper_functions/plot.mean.diffs.R")
source("helper_functions/calc.mean.diffs.and.p.values.R")
source("helper_functions/create_volcano_plot.R")
source("helper_functions/create.significant.genes.table.R")
```


# Data Exploration
## Mutation Counts
To find potential genes for classification, we plot the distribution of mutation numbers in the overlapping genes of the CCLE dataset and the datasets DRIVE and Achilles.

```{r fig.height=4, fig.width=10}
mutation.plot.DRIVE <- create.mutation.counts.plot.mark("DRIVE",dep.scores.DRIVE,
                                                   cancer.names,CCLE.mut)

mutation.plot.Achilles <- create.mutation.counts.plot.mark("Achilles",
                                                      dep.scores.Achilles,
                                                      cancer.names,CCLE.mut)

grid.arrange(mutation.plot.DRIVE,mutation.plot.Achilles,ncol=2)

rm(mutation.plot.DRIVE,mutation.plot.Achilles)
```

## Classification Tables for `r gene1` and `r gene2`
We create classification tables that show us for each cell line whether the selected genes are deleteriously mutated or not. Therefore we create one table where we check whether `r gene1` is deleteriously mutated, another table where we do the same for `r gene2` and a third table where we check whether at least one of `r gene1` and `r gene2` is deleteriously mutated.
```{r, eval=TRUE}
create.classification.table <- switch(classification.method,
                "del.vs.non.mut" = create.classification.table.del.vs.non.mut,
                "mut.vs.non.mut" = create.classification.table.mut.vs.non.mut)

class.table.gene1 <- create.classification.table(
                                                CCLE.mut, cancer.names,
                                                gene1, dep.scores.DRIVE,
                                                dep.scores.Achilles)
class.table.gene2 <- create.classification.table(
                                                CCLE.mut, cancer.names,
                                                gene2, dep.scores.DRIVE,
                                                dep.scores.Achilles)

# merge tables
class.table.comb.DRIVE <- merge.class.tables(class.table.gene1$DRIVE,
                                             class.table.gene2$DRIVE)

class.table.comb.Achilles <- merge.class.tables(class.table.gene1$Achilles,
                                             class.table.gene2$Achilles)

knitr::kable(head(class.table.comb.DRIVE), format = "html",
             table.attr = "style='width:50%;'",
             caption = "Significant Genes in DRIVE")

rm(CCLE.mut,cancer.names)
```

## Classifications for `r gene1`
To check whether the samples sizes regarding `r gene1` for the following statistical tests are sufficient, we plot the number of cell lines for both samples.
```{r eval=TRUE, fig.height=4, fig.width=10}
barcharts.gene1 <- create_barcharts_classifications(class.table.gene1$DRIVE,
                                              class.table.gene1$Achilles,
                                              gene1)
plot_grid(barcharts.gene1$DRIVE, barcharts.gene1$Achilles)
rm(barcharts.gene1)
```

## Classifications for `r gene2`
We repeat the plots for `r gene2`.
```{r eval=TRUE, fig.height=4, fig.width=10}
barcharts.gene2 <- create_barcharts_classifications(class.table.gene2$DRIVE,
                                              class.table.gene2$Achilles,
                                              gene2)
plot_grid(barcharts.gene2$DRIVE, barcharts.gene2$Achilles)
rm(barcharts.gene2)
```

## Classifications for `r gene1`and `r gene2`
We repeat the plots for `r gene1`and `r gene2`.
```{r eval=TRUE, fig.height=4, fig.width=10}
barcharts.comb.genes <- create_barcharts_classifications(class.table.comb.DRIVE,
                                              class.table.comb.Achilles,
                                              paste(gene1,"and",gene2))
plot_grid(barcharts.comb.genes$DRIVE, barcharts.comb.genes$Achilles)
rm(barcharts.comb.genes)
```

# Data Analysis `r gene1`
In order to detect differences between both samples, we compare them for each gene in the datasets DRIVE and Achilles. The workflow was published by [Chan et al., 2019](https://www.nature.com/articles/s41586-019-1102-x).

## Dependency Score Distributions
```{r eval=FALSE, include=FALSE}
dep.scores.Achilles.target <- cbind(dep.scores.Achilles["CCLE_ID"],
                                    dep.scores.Achilles[target.genes[1]])

dep.scores.Achilles.target <- merge(dep.scores.Achilles.target, 
                                       class.table.gene1$Achilles)
colnames(dep.scores.Achilles.target)[2] <- "target.gene"


ggplot(dep.scores.Achilles.target, aes(isDeleterious,target.gene)) +
  geom_boxplot() +
  geom_jitter() +
  xlab("") +
  ylab(paste("Dependency Score for",target.genes[1]))
```

## Mean Differences
To test whether the two groups respond differently to the knock out or the knock down of a specific gene, we calculate the mean differences between the two groups for each gene.
```{r eval=TRUE, fig.height=4, fig.width=10,message=FALSE}
test.results.gene1 <- calc.mean.diffs.and.p.values(dep.scores.DRIVE, 
                                           dep.scores.Achilles,
                                           class.table.gene1$DRIVE,
                                           class.table.gene1$Achilles)

plots <- plot.mean.diffs(test.results.gene1)
grid.arrange(plots$DRIVE,plots$Achilles,ncol=2)

rm(class.table.gene1,plots)
```

## Welch Test
The Welch t-test checks whether the means of two samples are identical. The prerequisite is that both samples are normally distributed, which we have not yet ensured.
```{r eval=TRUE, fig.height=4, fig.width=10}
plot.welch.DRIVE.gene1 <- create_volcano_plot(test.results.gene1,"DRIVE",
                                              "welch",target.genes,
                                              show_sign_line=F)

plot.welch.Achilles.gene1 <- create_volcano_plot(test.results.gene1,"Achilles",
                                                "welch",target.genes)

grid.arrange(plot.welch.DRIVE.gene1,plot.welch.Achilles.gene1,ncol=2)

rm(plot.welch.DRIVE.gene1,plot.welch.Achilles.gene1)
```

To discover new potential dependencies, the table shows all significant genes.
```{r}
significant.genes.table.DRIVE.gene1 <- create.significant.genes.table(
  test.results.gene1,"DRIVE","welch")
significant.genes.table.Achilles.gene1 <- create.significant.genes.table(
  test.results.gene1,"Achilles","welch")

knitr::kable(significant.genes.table.DRIVE.gene1, format = "html",
             table.attr = "style='width:50%;'",
             caption = "Significant Genes in DRIVE")
knitr::kable(significant.genes.table.Achilles.gene1, format = "html",
             table.attr = "style='width:50%;'", 
             caption = "Significant Genes in Achilles")

rm(significant.genes.table.DRIVE.gene1,significant.genes.table.Achilles.gene1)
```


## Wilcoxon Test
The Wilcoxon test checks whether, for randomly selected values X and Y from two samples, the probability of X being greater than Y is equal to the probability of Y being greater than X. The prerequisite is that the data are ordinary, which is fulfilled here.
```{r eval=TRUE, fig.height=4, fig.width=10}
plot.wilc.DRIVE.gene1 <- create_volcano_plot(test.results.gene1,"DRIVE","wilc",
                                       target.genes, show_sign_line=T)

plot.wilc.Achilles.gene1 <- create_volcano_plot(test.results.gene1,"Achilles",
                                                "wilc",target.genes)

grid.arrange(plot.wilc.DRIVE.gene1,plot.wilc.Achilles.gene1,ncol=2)

rm(plot.wilc.DRIVE.gene1,plot.wilc.Achilles.gene1)
```

```{r}
significant.genes.table.DRIVE.gene1 <- create.significant.genes.table(
  test.results.gene1,"DRIVE","wilc")
significant.genes.table.Achilles.gene1 <- create.significant.genes.table(
  test.results.gene1,"Achilles","wilc")

knitr::kable(significant.genes.table.DRIVE.gene1, format = "html",
             table.attr = "style='width:50%;'",
             caption = "Significant Genes in DRIVE")
knitr::kable(significant.genes.table.Achilles.gene1, format = "html",
             table.attr = "style='width:50%;'", 
             caption = "Significant Genes in Achilles")

rm(significant.genes.table.DRIVE.gene1,significant.genes.table.Achilles.gene1)
```


## Bayes Test
```{r eval=TRUE, fig.height=4, fig.width=10}
plot.bayes.DRIVE.gene1 <- create_volcano_plot(test.results.gene1,"DRIVE","bayes",
                                       target.genes)

plot.bayes.Achilles.gene1 <- create_volcano_plot(test.results.gene1,"Achilles",
                                                "bayes",target.genes)

grid.arrange(plot.bayes.DRIVE.gene1,plot.bayes.Achilles.gene1,ncol=2)

rm(plot.bayes.DRIVE.gene1,plot.bayes.Achilles.gene1)
```


```{r}
significant.genes.table.DRIVE.gene1 <- create.significant.genes.table(
  test.results.gene1,"DRIVE","bayes")
significant.genes.table.Achilles.gene1 <- create.significant.genes.table(
  test.results.gene1,"Achilles","bayes")

knitr::kable(significant.genes.table.DRIVE.gene1, format = "html",
             table.attr = "style='width:50%;'",
             caption = "Significant Genes in DRIVE")
knitr::kable(significant.genes.table.Achilles.gene1, format = "html",
             table.attr = "style='width:50%;'", 
             caption = "Significant Genes in Achilles")

rm(significant.genes.table.DRIVE.gene1,significant.genes.table.Achilles.gene1,
   test.results.gene1)
```

# Data Analysis `r gene2`
We do the same for `r gene2`.

## Mean Differences
```{r eval=TRUE, fig.height=4, fig.width=10}
test.results.gene2 <- calc.mean.diffs.and.p.values(dep.scores.DRIVE, 
                                           dep.scores.Achilles,
                                           class.table.gene2$DRIVE,
                                           class.table.gene2$Achilles)

plots <- plot.mean.diffs(test.results.gene2)
grid.arrange(plots$DRIVE,plots$Achilles,ncol=2)

rm(class.table.gene2,plots)
```

## Welch Test
```{r eval=TRUE, fig.height=4, fig.width=10}
plot.welch.DRIVE.gene2 <- create_volcano_plot(test.results.gene2,"DRIVE",
                                              "welch",target.genes,
                                              show_sign_line=T)

plot.welch.Achilles.gene2 <- create_volcano_plot(test.results.gene2,"Achilles",
                                                "welch",target.genes)

grid.arrange(plot.welch.DRIVE.gene2,plot.welch.Achilles.gene2,ncol=2)

rm(plot.welch.DRIVE.gene2,plot.welch.Achilles.gene2)
```


```{r}
significant.genes.table.DRIVE.gene2 <- create.significant.genes.table(
  test.results.gene2,"DRIVE","welch")
significant.genes.table.Achilles.gene2 <- create.significant.genes.table(
  test.results.gene2,"Achilles","welch")

knitr::kable(significant.genes.table.DRIVE.gene2, format = "html",
             table.attr = "style='width:50%;'",
             caption = "Significant Genes in DRIVE")
knitr::kable(significant.genes.table.Achilles.gene2, format = "html",
             table.attr = "style='width:50%;'", 
             caption = "Significant Genes in Achilles")

rm(significant.genes.table.DRIVE.gene2,significant.genes.table.Achilles.gene2)
```

## Wilcoxon Test
```{r eval=TRUE, fig.height=4, fig.width=10}
plot.wilc.DRIVE.gene2 <- create_volcano_plot(test.results.gene2,"DRIVE","wilc",
                                       target.genes, show_sign_line=T)

plot.wilc.Achilles.gene2 <- create_volcano_plot(test.results.gene2,"Achilles",
                                                "wilc",target.genes)

grid.arrange(plot.wilc.DRIVE.gene2,plot.wilc.Achilles.gene2,ncol=2)

rm(plot.wilc.DRIVE.gene2,plot.wilc.Achilles.gene2)
```


```{r}
significant.genes.table.DRIVE.gene2 <- create.significant.genes.table(
  test.results.gene2,"DRIVE","wilc")
significant.genes.table.Achilles.gene2 <- create.significant.genes.table(
  test.results.gene2,"Achilles","wilc")

knitr::kable(significant.genes.table.DRIVE.gene2, format = "html",
             table.attr = "style='width:50%;'",
             caption = "Significant Genes in DRIVE")
knitr::kable(significant.genes.table.Achilles.gene2, format = "html",
             table.attr = "style='width:50%;'", 
             caption = "Significant Genes in Achilles")

rm(significant.genes.table.DRIVE.gene2,significant.genes.table.Achilles.gene2)
```


## Bayes Test
```{r eval=TRUE, fig.height=4, fig.width=10}
plot.bayes.DRIVE.gene2 <- create_volcano_plot(test.results.gene2,"DRIVE","bayes",
                                       target.genes)

plot.bayes.Achilles.gene2 <- create_volcano_plot(test.results.gene2,"Achilles",
                                                "bayes",target.genes)

grid.arrange(plot.bayes.DRIVE.gene2,plot.bayes.Achilles.gene2,ncol=2)

rm(plot.bayes.DRIVE.gene2,plot.bayes.Achilles.gene2)
```


```{r}
significant.genes.table.DRIVE.gene2 <- create.significant.genes.table(
  test.results.gene2,"DRIVE","bayes")
significant.genes.table.Achilles.gene2 <- create.significant.genes.table(
  test.results.gene2,"Achilles","bayes")

knitr::kable(significant.genes.table.DRIVE.gene2, format = "html",
             table.attr = "style='width:50%;'",
             caption = "Significant Genes in DRIVE")
knitr::kable(significant.genes.table.Achilles.gene2, format = "html",
             table.attr = "style='width:50%;'", 
             caption = "Significant Genes in Achilles")

rm(significant.genes.table.DRIVE.gene2,significant.genes.table.Achilles.gene2,
   test.results.gene2)
```

# Data Analysis `r gene1` and `r gene2`
We do the same for `r gene1` and `r gene2` combined.

## Mean Differences
```{r eval=TRUE, fig.height=4, fig.width=10}
test.results.gene12 <- calc.mean.diffs.and.p.values(dep.scores.DRIVE, 
                                           dep.scores.Achilles,
                                           class.table.comb.DRIVE,
                                           class.table.comb.Achilles)

plots <- plot.mean.diffs(test.results.gene12)
grid.arrange(plots$DRIVE,plots$Achilles,ncol=2)

rm(class.table.comb.DRIVE,class.table.comb.Achilles,plots)
```

## Welch Test
```{r eval=TRUE, fig.height=4, fig.width=10}
plot.welch.DRIVE.gene12 <- create_volcano_plot(test.results.gene12,"DRIVE",
                                              "welch",target.genes)

plot.welch.Achilles.gene12 <- create_volcano_plot(test.results.gene12,"Achilles",
                                                "welch",target.genes)

grid.arrange(plot.welch.DRIVE.gene12,plot.welch.Achilles.gene12,ncol=2)

rm(plot.welch.DRIVE.gene12,plot.welch.Achilles.gene12)
```


```{r}
significant.genes.table.DRIVE.gene12 <- create.significant.genes.table(
  test.results.gene12,"DRIVE","welch")
significant.genes.table.Achilles.gene12 <- create.significant.genes.table(
  test.results.gene12,"Achilles","welch")

knitr::kable(significant.genes.table.DRIVE.gene12, format = "html",
             table.attr = "style='width:50%;'",
             caption = "Significant Genes in DRIVE")
knitr::kable(significant.genes.table.Achilles.gene12, format = "html",
             table.attr = "style='width:50%;'", 
             caption = "Significant Genes in Achilles")

rm(significant.genes.table.DRIVE.gene12,significant.genes.table.Achilles.gene12)
```

## Wilcoxon Test
```{r eval=TRUE, fig.height=4, fig.width=10}
plot.wilc.DRIVE.gene12 <- create_volcano_plot(test.results.gene12,"DRIVE","wilc",
                                       target.genes, show_sign_line=T)

plot.wilc.Achilles.gene12 <- create_volcano_plot(test.results.gene12,"Achilles",
                                                "wilc",target.genes)

grid.arrange(plot.wilc.DRIVE.gene12,plot.wilc.Achilles.gene12,ncol=2)

rm(plot.wilc.DRIVE.gene12,plot.wilc.Achilles.gene12)
```


```{r}
significant.genes.table.DRIVE.gene12 <- create.significant.genes.table(
  test.results.gene12,"DRIVE","wilc")
significant.genes.table.Achilles.gene12 <- create.significant.genes.table(
  test.results.gene12,"Achilles","wilc")

knitr::kable(significant.genes.table.DRIVE.gene12, format = "html",
             table.attr = "style='width:50%;'",
             caption = "Significant Genes in DRIVE")
knitr::kable(significant.genes.table.Achilles.gene12, format = "html",
             table.attr = "style='width:50%;'", 
             caption = "Significant Genes in Achilles")

rm(significant.genes.table.DRIVE.gene12,significant.genes.table.Achilles.gene12)
```


## Bayes Test
```{r eval=TRUE, fig.height=4, fig.width=10}
plot.bayes.DRIVE.gene12 <- create_volcano_plot(test.results.gene12,"DRIVE",
                                               "bayes",target.genes)

plot.bayes.Achilles.gene12 <- create_volcano_plot(test.results.gene12,
                                                  "Achilles","bayes",
                                                  target.genes)

grid.arrange(plot.bayes.DRIVE.gene12,plot.bayes.Achilles.gene12,ncol=2)

rm(plot.bayes.DRIVE.gene12,plot.bayes.Achilles.gene12)
```


```{r}
significant.genes.table.DRIVE.gene12 <- create.significant.genes.table(
  test.results.gene12,"DRIVE","bayes")
significant.genes.table.Achilles.gene12 <- create.significant.genes.table(
  test.results.gene12,"Achilles","bayes")

knitr::kable(significant.genes.table.DRIVE.gene12, format = "html",
             table.attr = "style='width:50%;'",
             caption = "Significant Genes in DRIVE")
knitr::kable(significant.genes.table.Achilles.gene12, format = "html",
             table.attr = "style='width:50%;'", 
             caption = "Significant Genes in Achilles")

rm(significant.genes.table.DRIVE.gene12,significant.genes.table.Achilles.gene12,
   test.results.gene12)
```