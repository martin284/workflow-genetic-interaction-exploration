---
title: "Genetic dependency interaction in MSI cells"
author: "Martin Brand"
date: "`r format(Sys.time(), '%B %e, %Y')`"
output:
  bookdown::html_document2:
    code_folding: hide
    fig_caption: yes
    number_sections: no
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
    toc_collapsed: yes
    fig_width: 8 
    fig_height: 4 
  bookdown::pdf_document2:
    keep_tex: yes
    fig_caption: yes
    number_sections: no
    toc: yes
    toc_depth: 3
graphics: yes
header-includes:
- \makeatletter\renewcommand*{\fps@figure}{h}\makeatother
- \usepackage{placeins}
geometry: margin=1in
fontsize: 18pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, warning=FALSE}
Sys.setenv(LANG = "en")
library(dplyr)
library(ggplot2)
library(kableExtra)
library(matrixTests)
library(limma)
library(ggrepel)
library(gridExtra)
library(ComplexHeatmap)
library(readxl)
```

First, we define the target genes to be displayed in the volcano plots.
```{r}
target.genes <- c("WRN")
```

# Data Preprocessing
We import the datasets and functions.
```{r, eval=FALSE}
library(CePa)
path <- "C:/Users/Martin/Documents/Master/Thesis/CCLE_data/"
expression.data <- 
  read.gct(
    paste0(path,"Expression_Files/CCLE_Expression_Entrez_2012-09-29.gct"))
expression.data <- as.data.frame(expression.data)
saveRDS(expression.data,
        file=paste0(path,"Expression_Files/expression.data.rds"))
```

```{r, warning=FALSE}
path <- 
  "C:/Users/Martin/Documents/Master/Thesis/genetic_dependency_detection/data/"

MSI.status <- read_excel(paste0(path, "supplementary_table.xlsx"))
MSI.status <- MSI.status[,c(1,4)]

# load Achilles and DRIVE
dep.scores.DRIVE <- readRDS(paste0(path,"dep.scores.DRIVE.rds"))
dep.scores.Achilles <- readRDS(paste0(path,"dep.scores.Achilles.rds"))

rm(path)

source("helper_functions/calc.mean.diffs.and.p.values.R")
source("helper_functions/create_volcano_plot.R")
source("helper_functions/create.classification.table.expr.R")
```

# Data Analysis
## Classification table
We create two samples. One sample contains the MSI cell lines and the other contains the MSS cell lines. We summarize the samples in a classification table.
```{r}
# convert MSI status information to classification table
class.table <- MSI.status
class.table <- class.table %>% mutate(
  isDeleterious = case_when(CCLE_MSI == "MSI" ~ T,CCLE_MSI == "MSS" ~ F))
class.table$CCLE_MSI <- NULL 
class.table <- na.omit(class.table)

class.table.DRIVE <- merge(class.table,dep.scores.DRIVE['CCLE_ID'],
                           by="CCLE_ID")
class.table.Achilles <- merge(class.table,dep.scores.Achilles['CCLE_ID'],
                           by="CCLE_ID")

#rm(MSI.status)

# show tables
class.table.DRIVE %>%
  head() %>%
  kbl(caption = "Classification Table in DRIVE") %>%
  kable_styling()
class.table.Achilles %>%
  head %>%
  kbl(caption = "Classification Table in Achilles") %>%
  kable_styling()
```

## Welch's t-test
We calculate the mean values of the dependency scores of both samples, take the difference and calculate the p-value using Welch's t-test.
```{r}
res <- calc.mean.diffs.and.p.values(dep.scores.DRIVE,dep.scores.Achilles,
                                    class.table.DRIVE,class.table.Achilles)

rm(class.table.DRIVE,class.table.Achilles,class.table,dep.scores.DRIVE,
   dep.scores.Achilles)
```

```{r eval=TRUE, fig.height=4, fig.width=10, message=F}
plot.welch.DRIVE <- create_volcano_plot(test_results=res,
                                        dataset="DRIVE",
                                        test_method="welch",
                                        labeled_genes=target.genes,
                                        show_y_label=TRUE)

plot.welch.Achilles <- create_volcano_plot(test_results=res,
                                        dataset="Achilles",
                                        test_method="welch",
                                        labeled_genes=target.genes,
                                        show_y_label=FALSE)

plot.welch <- grid.arrange(plot.welch.DRIVE,plot.welch.Achilles,ncol=2)

# save plot
plot_path <- "C:/Users/Martin/Documents/Master/Thesis/report/plots/"
# ggsave(file=paste0(plot_path,"volcano_MSI_welch.svg"), plot=plot.welch,
#        width=10)
# ggsave(file=paste0(plot_path,"volcano_MSI_welch.png"), plot=plot.welch,
# width=10)

rm(plot.welch.DRIVE,plot.welch.Achilles,plot.welch)
```

## Wilcoxon test
We repeat the calculation of the p-values with the Wilcoxon test.
```{r eval=TRUE, fig.height=4, fig.width=10}
plot.wilc.DRIVE <- create_volcano_plot(test_results=res,
                                       dataset="DRIVE",
                                       test_method="wilc",
                                       labeled_genes=target.genes,
                                       show_y_label=TRUE)

plot.wilc.Achilles <- create_volcano_plot(test_results=res,
                                       dataset="Achilles",
                                       test_method="wilc",
                                       labeled_genes=target.genes,
                                       show_y_label=FALSE)

plot.wilc <- grid.arrange(plot.wilc.DRIVE,plot.wilc.Achilles,ncol=2)

# save plot
# ggsave(file=paste0(plot_path,"volcano_MSI_wilc.svg"), plot=plot.wilc,
#        width=10)
# ggsave(file=paste0(plot_path,"volcano_MSI_wilc.png"), plot=plot.wilc,
#        width=10)

rm(plot.wilc.DRIVE,plot.wilc.Achilles,plot.wilc)
```


## Bayes moderated t-test
And finally, we calculate the p-values with the Bayes moderated t-test.
```{r eval=TRUE, fig.height=4, fig.width=10}
plot.bayes.DRIVE <- create_volcano_plot(test_results=res,
                                       dataset="DRIVE",
                                       test_method="bayes",
                                       labeled_genes=target.genes,
                                       show_y_label=TRUE)

plot.bayes.Achilles <- create_volcano_plot(test_results=res,
                                       dataset="Achilles",
                                       test_method="bayes",
                                       labeled_genes=target.genes,
                                       show_y_label=FALSE)

plot.bayes <- grid.arrange(plot.bayes.DRIVE,plot.bayes.Achilles,ncol=2)

# save plot
# ggsave(file=paste0(plot_path,"volcano_MSI_bayes.svg"), plot=plot.bayes,
#        width=10)
# ggsave(file=paste0(plot_path,"volcano_MSI_bayes.png"), plot=plot.bayes,
#        width=10)

rm(plot.bayes.DRIVE,plot.bayes.Achilles,target.genes,plot.bayes)
```



## Upset plots
To investigate whether genes have significant p-values in multiple tests and datasets, we create an upset plot. Each set contains all genes that are significant in the corresponding dataset and test method.
```{r fig.width=8}
# extract significant genes from res object
threshold <- 0.05
sign.genes.welch.DRIVE <- 
  res$p_values_welch_DRIVE %>% filter(p_adj < threshold) %>% pull(gene)
sign.genes.welch.Achilles <- 
  res$p_values_welch_Achilles %>% filter(p_adj < threshold) %>% pull(gene)
sign.genes.wilc.DRIVE <- 
  res$p_values_wilc_DRIVE %>% filter(p_adj < threshold) %>% pull(gene)
sign.genes.wilc.Achilles <- 
  res$p_values_wilc_Achilles %>% filter(p_adj < threshold) %>% pull(gene)
sign.genes.bayes.DRIVE <- 
  res$p_values_bayes_DRIVE %>% filter(p_adj < threshold) %>% pull(gene)
sign.genes.bayes.Achilles <- 
  res$p_values_bayes_Achilles %>% filter(p_adj < threshold) %>% pull(gene)

# collect in list
sign.genes <- list()
if(length(sign.genes.welch.DRIVE)>0){
  sign.genes[[ "welch.DRIVE" ]] = sign.genes.welch.DRIVE}
if(length(sign.genes.wilc.DRIVE)>0){
  sign.genes[[ "wilc.DRIVE" ]] = sign.genes.wilc.DRIVE}
if(length(sign.genes.bayes.DRIVE)>0){
  sign.genes[[ "bayes.DRIVE" ]] = sign.genes.bayes.DRIVE}
if(length(sign.genes.welch.Achilles)>0){
  sign.genes[[ "welch.Achilles" ]] = sign.genes.welch.Achilles}
if(length(sign.genes.wilc.Achilles)>0){
  sign.genes[[ "wilc.Achilles" ]] = sign.genes.wilc.Achilles}
if(length(sign.genes.bayes.Achilles)>0){
  sign.genes[[ "bayes.Achilles" ]] = sign.genes.bayes.Achilles}

# create combination matrix
comb.mat = make_comb_mat(list_to_matrix(sign.genes),mode="intersect")

# define order of sets
set.order <- c()
if(length(sign.genes$welch.DRIVE)>0) {
  set.order <- append(set.order,"welch.DRIVE")}
if(length(sign.genes$wilc.DRIVE)>0) {
  set.order <- append(set.order,"wilc.DRIVE")}
if(length(sign.genes$bayes.DRIVE)>0) {
  set.order <- append(set.order,"bayes.DRIVE")}
if(length(sign.genes$welch.Achilles)>0) {
  set.order <- append(set.order,"welch.Achilles")}
if(length(sign.genes$wilc.Achilles)>0) {
  set.order <- append(set.order,"wilc.Achilles")}
if(length(sign.genes$bayes.Achilles)>0) {
  set.order <- append(set.order,"bayes.Achilles")}

# plot
UpSet(comb.mat,set_order=set.order)

rm(threshold,res,set.order,comb.mat)
```

## Significant genes
We list the genes that appear in the maximum number of significant gene sets.
```{r}
# create Boolean matrix for gene in sets
sign.genes.total <- unique(unlist(sign.genes))
genes.set.table <- as.data.frame(cbind(geneID=sign.genes.total))

check.dataset <- function(gene.name,dataset) {
  return(gene.name %in% dataset)
}

if(length(sign.genes.welch.DRIVE)>0) {
  genes.set.table$welch.DRIVE <- 
    sapply(genes.set.table$geneID, check.dataset,sign.genes.welch.DRIVE)}
if(length(sign.genes.wilc.DRIVE)>0) {
  genes.set.table$wilc.DRIVE <- 
    sapply(genes.set.table$geneID, check.dataset,sign.genes.wilc.DRIVE)}
if(length(sign.genes.bayes.DRIVE)>0) {
  genes.set.table$bayes.DRIVE <- 
    sapply(genes.set.table$geneID, check.dataset,sign.genes.bayes.DRIVE)}
if(length(sign.genes.welch.Achilles)>0) {
  genes.set.table$welch.Achilles <- 
    sapply(genes.set.table$geneID, check.dataset,sign.genes.welch.Achilles)}
if(length(sign.genes.wilc.Achilles)>0) {
  genes.set.table$wilc.Achilles <- 
    sapply(genes.set.table$geneID, check.dataset,sign.genes.wilc.Achilles)}
if(length(sign.genes.bayes.Achilles)>0) {
  genes.set.table$bayes.Achilles <- 
    sapply(genes.set.table$geneID, check.dataset,sign.genes.bayes.Achilles)}


# count how often genes occur in sets
genes.set.table$sum <- rowSums(genes.set.table[,-1])

# extract all genes that occur in maximal number of sets
max.set <- max(genes.set.table$sum)
final.sign.genes <- filter(genes.set.table,sum==max.set)

# show result
final.sign.genes['geneID'] %>%
  kbl(caption = paste("Genes that are significant in",max.set,"sets.")) %>%
  kable_styling()

rm(sign.genes.welch.DRIVE,sign.genes.wilc.DRIVE,sign.genes.bayes.DRIVE,
   sign.genes.welch.Achilles,sign.genes.wilc.Achilles,
   sign.genes.bayes.Achilles,genes.set.table,sign.genes)
```
